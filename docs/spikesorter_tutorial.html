<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="P. M. Thompson">

<title>Protocols - Spike Sorting Tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Protocols</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./spikesorter_tutorial.html" rel="" target="" aria-current="page">
 <span class="menu-text">Spike Sorting Tutorial</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a>
  <ul class="collapse">
  <li><a href="#data-format" id="toc-data-format" class="nav-link" data-scroll-target="#data-format">Data Format</a></li>
  <li><a href="#probe-configuration" id="toc-probe-configuration" class="nav-link" data-scroll-target="#probe-configuration">Probe Configuration</a></li>
  <li><a href="#quality-metrics" id="toc-quality-metrics" class="nav-link" data-scroll-target="#quality-metrics">Quality Metrics</a></li>
  </ul></li>
  <li><a href="#sorting" id="toc-sorting" class="nav-link" data-scroll-target="#sorting">Sorting</a>
  <ul class="collapse">
  <li><a href="#preparing-and-loading-data" id="toc-preparing-and-loading-data" class="nav-link" data-scroll-target="#preparing-and-loading-data">Preparing and Loading Data</a></li>
  <li><a href="#pre-processing" id="toc-pre-processing" class="nav-link" data-scroll-target="#pre-processing">Pre-processing</a></li>
  <li><a href="#event-detection" id="toc-event-detection" class="nav-link" data-scroll-target="#event-detection">Event Detection</a></li>
  <li><a href="#clustering" id="toc-clustering" class="nav-link" data-scroll-target="#clustering">Clustering</a></li>
  </ul></li>
  <li><a href="#quality-metrics-revisited" id="toc-quality-metrics-revisited" class="nav-link" data-scroll-target="#quality-metrics-revisited">Quality Metrics Revisited</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Spike Sorting Tutorial</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>P. M. Thompson </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="background" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>Before sorting, there are several key details to understand:</p>
<section id="data-format" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="data-format">Data Format</h3>
<p>Multi-channel data from the Intan Recording Software (RHX) is saved as <strong>binary data</strong>, meaning that there is no information in the data file to tell your computer details about the information inside. Compare this to a .MAT file, which includes some information about how many variables there are, how big the variables are etc. For binary data, we need to know some details of how it was obtained to understand how to open it.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Binary data</strong> is is a data format where the user needs to specify how the data is stored in computer memory. This includes the datatype (e.g.&nbsp;Int16), and how the data is arranged (e.g.&nbsp;channels x time) array.</p>
</div></div><p>Intan data files are called amplifier.dat. Each voltage value from the recording software is recorded as a Int16 value, meaning that the computer dedicates 16-bits (1s and 0s) to storing the values, and they can be positive or negative. To convert to more meaningful voltage values, Intan tells us that each increment (e.g.&nbsp;from 0 to 1) corresponds to 0.195 uV.</p>
<p>The amplifier.dat file is an array of voltage values. We must also know the organization of this array; if the first value is the voltage on the first channel, does the second value correspond to the voltage at the same time from the 2nd channel? Or does it correspond to the voltage at timepoint 2 on channel 1? In other words, is the data organized as channels by time, or time by channels? Electrophysiology data is almost always written as channel_1_time_1, channel_2_time1, channel_3_time_1 etc, or channels by time.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Binary data can be converted to voltage vs time by scaling the time axis with the sampling rate and the magnitude axis with the voltage/bit</p>
</div></div><p>We also must know the sampling rate. For Intan data this is typically 30000 Hz. In other words, each sample is 1/30000 in duration.</p>
</section>
<section id="probe-configuration" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="probe-configuration">Probe Configuration</h3>
<p>Sorting and visualization are greatly aided by knowing the physical relationship between recording channels. Unfortunately, both the connection of the probe to the probe holder and the connection of the probe holder to the headstage scrambles the channel numbers. Additionally, for each probe type/adapter/headstage combination, this relationship will be different.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>The channel identifier in saved data (1,2,3 etc) does NOT correspond to the channel ID on the silicon probe</p>
</div></div><p>Common probe configurations used in the lab, along with useful files can be found at the address below:</p>
<p><a href="https://github.com/paulmthompson/silicon-probes" class="uri">https://github.com/paulmthompson/silicon-probes</a></p>
<p>For spike sorting, we will need the <strong>electrode.cfg</strong> file for the probe type of interest.</p>
</section>
<section id="quality-metrics" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="quality-metrics">Quality Metrics</h3>
<p>What does a well isolated single unit look like? This is a difficult question, and evidence suggests that spike sorting routines are particularly poor at determining this. In fact, when popular programs have been applied to the same data only 10% of spikes have been found by all of the programs (yikes) <span class="citation" data-cites="buccino2020">(<a href="#ref-buccino2020" role="doc-biblioref">Buccino et al. 2020</a>)</span></p>
<p>Objective metrics calculated from our data should theoretically aid us in determining if a unit is well isolated, but these metrics can also be misleading if not used carefully. I have seen evidence in the literature that the way metrics are calculated has changed over time, and they have changed in such a way that they are more lenient, perhaps by as much as an order of magnitude.</p>
<p>In a well-designed recording rig, even in difficult to record brain areas, we should be able to use strict criteria during manual sorting as well as strict metrics and still have multiple well isolated single units for each recording session.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use sorting metrics to help cleanup the borderline cases. If they are doing the majority of the work you have perhaps mis-identified useful metrics or you are being overly optimistic during your manual sorting about what a unit is and is not.</p>
</div>
</div>
<section id="signal-to-noise-ratio-snr" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="signal-to-noise-ratio-snr">Signal-to-Noise Ratio (SNR)</h4>
<p>The single most important metric is the signal-to-noise ratio. You should have a general idea of this one from experimental time because it should roughly tell you how big is my neuronal signal compared to the noise. I have found at least 3 different ways to calculate this in the literature:</p>
<p><span id="eq-pp-std"><span class="math display">\[\frac{V_{template,peak-to-peak}}{V_{std}} \tag{1}\]</span></span></p>
<p><span id="eq-pp-pp"><span class="math display">\[\frac{V_{template,peak-to-peak}}{V_{peak-to-peak}} \tag{2}\]</span></span></p>
<p><span id="eq-amp-pp"><span class="math display">\[\frac{V_{template,amplitude}}{V_{std}} \tag{3}\]</span></span></p>
<p>The most “correct” SNR by definition is peak-to-peak voltage over root-mean-square voltage (<a href="#eq-pp-std">Equation&nbsp;1</a>), which is roughly equivalent to standard deviation. However, this is a difficult quantity to mentally compute from looking at the raw data, AND this results in the largest SNR values of the three equations. Peak-to-Peak waveform voltage over the noise peak-to-peak voltage (<a href="#eq-pp-pp">Equation&nbsp;2</a>) is easy to intuit because it is roughly the height of the spike vs the height of the noise. Note however that this quantity tends to be perhaps 5-10 times smaller than SNR calculated as in <a href="#eq-pp-std">Equation&nbsp;1</a>. This is because the peak-to-peak voltage of the noise is roughly 8 times larger than the standard deviation <span class="citation" data-cites="theaxon2012">(<a href="#ref-theaxon2012" role="doc-biblioref"><em>The Axon guide, electrophysiology and biophysics laboratory techniques</em> 2012</a>)</span>. Consequently, one should recognize that a sensible cutoff of SNR for differentiating signal from noise would also vary by almost an order of magnitude depending on how SNR was calculated.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Peak-to-peak voltages are easier to estimate by eye than standard deviations</p>
</div></div><p>I recommend using only peak-to-peak voltages, and using a cutoff of approximately 2. Our spike sorting software and the authors who created it have used a cutoff around this value (1.8 - 2.5) <span class="citation" data-cites="swindale2023 swindale2017">(<a href="#ref-swindale2023" role="doc-biblioref">Nicholas V. Swindale et al. 2023</a>; <a href="#ref-swindale2017" role="doc-biblioref">Nicholas V. Swindale et al. 2017</a>)</span>.</p>
<p>Note that recent cutting edge electrophysiology papers from the International Brain Laboratory have used a similar cutoff of 2.5 with popular algorithms like Kilosort2 <span class="citation" data-cites="inagaki2022">(<a href="#ref-inagaki2022" role="doc-biblioref">Inagaki et al. 2022</a>)</span>. Superficially, this may appear to be more strict than what I am endorsing. However, note that the equation used by these authors is <a href="#eq-pp-std">Equation&nbsp;1</a>, and with this method, SNR=2.5 is barely distinguishable from noise (<a href="#fig-snr-plots">Figure&nbsp;1</a>). Confusingly, about 8 years prior, this group used a SNR cutoff of at least 5 <span class="citation" data-cites="Guo2014">(<a href="#ref-Guo2014" role="doc-biblioref">Guo et al. 2014, fig. S3</a>)</span>, with average SNR around 10, which is much more reasonable. These gradual decays in quality over time are an important cautionary tale for understanding the underlying methodology.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_noise_ptp(noise,samples,repetitions):</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  max_noise <span class="op">=</span> np.zeros(repetitions)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  min_noise <span class="op">=</span> np.zeros(repetitions)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  noise_ptp <span class="op">=</span> np.zeros(repetitions)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,repetitions):</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    subsamples <span class="op">=</span> np.random.choice(noise_std,samples)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    max_noise[i] <span class="op">=</span> np.<span class="bu">max</span>(noise_std)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    min_noise[i] <span class="op">=</span> np.<span class="bu">min</span>(noise_std)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    noise_ptp[i] <span class="op">=</span> max_noise[i] <span class="op">-</span> min_noise[i]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  noise_ptp <span class="op">=</span> np.mean(noise_ptp)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  max_noise <span class="op">=</span> np.mean(max_noise)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  min_noise <span class="op">=</span> np.mean(min_noise)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> noise_ptp,max_noise,min_noise</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>template <span class="op">=</span> np.array([<span class="op">-</span><span class="fl">0.1513909</span> , <span class="op">-</span><span class="fl">0.16631116</span>, <span class="op">-</span><span class="fl">0.17847979</span>, <span class="op">-</span><span class="fl">0.18862691</span>, <span class="op">-</span><span class="fl">0.19872002</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.20880426</span>, <span class="op">-</span><span class="fl">0.21737931</span>, <span class="op">-</span><span class="fl">0.22361187</span>, <span class="op">-</span><span class="fl">0.22874592</span>, <span class="op">-</span><span class="fl">0.23452372</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.24082686</span>, <span class="op">-</span><span class="fl">0.24489726</span>, <span class="op">-</span><span class="fl">0.24255492</span>, <span class="op">-</span><span class="fl">0.22836725</span>, <span class="op">-</span><span class="fl">0.19307666</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.1191242</span> ,  <span class="fl">0.02425</span>   ,  <span class="fl">0.28417833</span>,  <span class="fl">0.71488001</span>,  <span class="fl">1.34970811</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="fl">2.15717331</span>,  <span class="fl">3.00861469</span>,  <span class="fl">3.70470693</span>,  <span class="fl">4.06647289</span>,  <span class="fl">4.02591484</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="fl">3.64727615</span>,  <span class="fl">3.07093063</span>,  <span class="fl">2.43142789</span>,  <span class="fl">1.8080954</span> ,  <span class="fl">1.2247536</span> ,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.67450634</span>,  <span class="fl">0.14624459</span>, <span class="op">-</span><span class="fl">0.36222091</span>, <span class="op">-</span><span class="fl">0.84091953</span>, <span class="op">-</span><span class="fl">1.2741004</span> ,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">1.6452294</span> , <span class="op">-</span><span class="fl">1.94012256</span>, <span class="op">-</span><span class="fl">2.14839704</span>, <span class="op">-</span><span class="fl">2.26756383</span>, <span class="op">-</span><span class="fl">2.30440089</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">2.27405578</span>, <span class="op">-</span><span class="fl">2.19505695</span>, <span class="op">-</span><span class="fl">2.0840863</span> , <span class="op">-</span><span class="fl">1.95470787</span>, <span class="op">-</span><span class="fl">1.81895549</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">1.68644032</span>, <span class="op">-</span><span class="fl">1.56235016</span>, <span class="op">-</span><span class="fl">1.44811373</span>, <span class="op">-</span><span class="fl">1.3434583</span> , <span class="op">-</span><span class="fl">1.24678163</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">1.15489337</span>, <span class="op">-</span><span class="fl">1.06493637</span>, <span class="op">-</span><span class="fl">0.97600263</span>, <span class="op">-</span><span class="fl">0.88764435</span>, <span class="op">-</span><span class="fl">0.79968051</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.71323625</span>, <span class="op">-</span><span class="fl">0.62895673</span>, <span class="op">-</span><span class="fl">0.54701365</span>, <span class="op">-</span><span class="fl">0.46780424</span>, <span class="op">-</span><span class="fl">0.39222975</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.32111773</span>, <span class="op">-</span><span class="fl">0.25396762</span>, <span class="op">-</span><span class="fl">0.19020192</span>, <span class="op">-</span><span class="fl">0.13038235</span>, <span class="op">-</span><span class="fl">0.07453424</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>       <span class="op">-</span><span class="fl">0.02132602</span>,  <span class="fl">0.02993237</span>,  <span class="fl">0.07660115</span>,  <span class="fl">0.11522204</span>,  <span class="fl">0.14610511</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.17122906</span>,  <span class="fl">0.19176712</span>,  <span class="fl">0.20754389</span>])</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>snr_values <span class="op">=</span> [<span class="fl">2.5</span>, <span class="fl">7.5</span>, <span class="fl">15.0</span>]</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>noise_length <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>pad <span class="op">=</span> <span class="bu">int</span>((noise_length <span class="op">-</span> <span class="bu">len</span>(template)) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>max_template <span class="op">=</span> np.<span class="bu">max</span>(template)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>min_template <span class="op">=</span> np.<span class="bu">min</span>(template)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>template_ptp <span class="op">=</span> max_template <span class="op">-</span> min_template</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>(fig,ax) <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="bu">len</span>(snr_values))</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,<span class="bu">len</span>(snr_values)):</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  snr_value <span class="op">=</span> snr_values[i]</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  padded_template <span class="op">=</span> np.zeros(noise_length)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  noise_std <span class="op">=</span> np.random.normal(loc<span class="op">=</span><span class="fl">0.0</span>,scale<span class="op">=</span>template_ptp <span class="op">/</span> snr_value, size<span class="op">=</span>noise_length)</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  noise_ptp,max_noise,min_noise <span class="op">=</span> get_noise_ptp(noise_std,<span class="bu">len</span>(template),<span class="dv">1000</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  template_over_noise <span class="op">=</span> copy.deepcopy(noise_std)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  template_over_noise[pad:<span class="bu">len</span>(template)<span class="op">+</span>pad] <span class="op">+=</span> template</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  padded_template[pad:<span class="bu">len</span>(template) <span class="op">+</span> pad] <span class="op">+=</span> template</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  ax[i].plot(template_over_noise,color<span class="op">=</span><span class="st">"black"</span>,label<span class="op">=</span><span class="st">"_Hidden"</span>,linewidth<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  ax[i].plot([<span class="dv">0</span>,noise_length],[max_template,max_template],linestyle<span class="op">=</span><span class="st">"dashed"</span>,color<span class="op">=</span><span class="st">"red"</span>,label<span class="op">=</span><span class="st">"_Hidden"</span>)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  ax[i].plot([<span class="dv">0</span>,noise_length],[min_template,min_template],linestyle<span class="op">=</span><span class="st">"dashed"</span>,color<span class="op">=</span><span class="st">"red"</span>,label<span class="op">=</span><span class="st">"Template </span><span class="ch">\n</span><span class="st"> Envelope"</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  ax[i].plot([<span class="dv">0</span>,noise_length],[max_noise,max_noise],linestyle<span class="op">=</span><span class="st">"dashed"</span>,color<span class="op">=</span><span class="st">"blue"</span>,label<span class="op">=</span><span class="st">"_Hidden"</span>)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  ax[i].plot([<span class="dv">0</span>,noise_length],[min_noise,min_noise],linestyle<span class="op">=</span><span class="st">"dashed"</span>,color<span class="op">=</span><span class="st">"blue"</span>,label<span class="op">=</span><span class="st">"Noise </span><span class="ch">\n</span><span class="st"> Envelope"</span>)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  <span class="co">#ax[i].plot(padded_template,color="red",alpha=0.2)</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  snr_std <span class="op">=</span> np.around(template_ptp <span class="op">/</span> np.std(noise_std),decimals<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  snr_ptp <span class="op">=</span> np.around(template_ptp <span class="op">/</span> (np.<span class="bu">max</span>(noise_std) <span class="op">-</span> np.<span class="bu">min</span>(noise_std)),decimals<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  ax[i].set_title(<span class="ss">f"SNR_std: </span><span class="sc">{</span>snr_std<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss"> SNR_ptp: </span><span class="sc">{</span>snr_ptp<span class="sc">}</span><span class="ss">"</span> )</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  ax[i].set_ylim([<span class="op">-</span><span class="dv">9</span>, <span class="dv">9</span>])</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  ax[i].set_xticks([])</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  ax[i].set_yticks([])</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  ax[i].set_xlabel(<span class="st">"Time"</span>)</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>    ax[i].set_ylabel(<span class="st">"Voltage"</span>)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">==</span> <span class="bu">len</span>(ax) <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    ax[i].legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-snr-plots" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="spikesorter_tutorial_files/figure-html/fig-snr-plots-output-1.png" width="558" height="446" class="figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: SNR calculation comparisons</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="amplitude" class="level4">
<h4 class="anchored" data-anchor-id="amplitude">Amplitude</h4>
<p>The waveform amplitude is part of the SNR calculation, so it is mostly just a kind of sanity check. Some spike sorting programs report this as the absolute value of the largest peak (positive or negative), while others report it as peak-to-peak voltage, which can be as much as double the size for a bi-phasic waveform. I recommend using a cutoff of 100 uV peak-to-peak, although few single units will have an SNR &gt; 2 with an amplitude smaller than 100uV at physiological noise levels.</p>
</section>
<section id="refractory-period-violation-metrics" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="refractory-period-violation-metrics">Refractory Period Violation Metrics</h4>
<p>It is common to report metrics relating to the refractory period. Briefly, neurons are inactivated after firing action potentials for a few milliseconds, so it is reasonably to assume that if a sorting algorithm is detecting more waveforms within this “refractory” window, it is either due to noise or multi-unit contamination.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Multiunit</strong> is used to refer to signals that appear to be from neural activity, but are not sufficiently well isolated to distinguish from one another</p>
</div></div><p>This is good in theory, but these metrics can be heavily biased downward as a result of temporal lockout built into sorting algorithms. After most sorting algorithms detect threshold crossings, they generally select the waveform, and then impose some lockout period before they look for more threshold crossings. For this reason, they tend to not even look for spikes during this “lockout period.” So a low ISI violation rate can still occur with low SNR units because of the sorting process itself.</p>
<p>ISI violation is reported in multiple ways. The simplest is to calculate the percentage of total spikes that within 1 refractory period width of one another. These tend to be quite low (1-2%).</p>
<p>There are more sophisticated methods that try to estimate proportion of spikes that are contaminated by multiunit spiking. There are lots of assumptions in these (such as uncorrelated units) and a stable mean firing rate, which can make these metrics biased upwards for bursty units like we see in the brainstem. They can be useful however. Often these are reported as between 0-1, roughly corresponding to 0% of spiking is contaminated and 100% contaminated.</p>
</section>
<section id="stability-across-time" class="level4">
<h4 class="anchored" data-anchor-id="stability-across-time">Stability across time</h4>
<p>Analysis of neural data usually requires the unit to be present throughout the course of the entire experiment; otherwise changes in activity may be falsely attributed to changes in behavior over that time. There can be abrupt changes in if a unit is present or not (for instance, bumping the experimental rig), but low SNR units could also come and go as they sink above and below the threshold for detection. Good manual sorting should exclude this second time of unit. Similarly, electrode drift may cause the shape of the neuronal waveform to change over time, and the sorting algorithm may falsely assign part of the activity to one unit, and part to another. Again, manual sorting should be able to catch these errors if the unit is sufficiently high SNR.</p>
<p>A presence ratio is usually the quantity calculated for this purpose, and 0.95 is a reasonable threshold.</p>
</section>
<section id="summary" class="level4">
<h4 class="anchored" data-anchor-id="summary">Summary</h4>
<p>Pre-specify some metrics for spike sorting that will serve as a threshold for including neurons in your analysis. However, most neurons that you call single units after manual curation should meet these thresholds anyway. A reasonable criteria matrix is as follows:</p>
<table class="table">
<caption>Recommended Quality Metrics</caption>
<tbody>
<tr class="odd">
<td>SNR (peak-to-peak signal / peak-to-peak noise) &gt; 2</td>
</tr>
<tr class="even">
<td>Amplitude (peak-to-peak) &gt; 100 uV</td>
</tr>
<tr class="odd">
<td>ISI violation &lt; 1%</td>
</tr>
<tr class="even">
<td>MUA contamination &lt; 0.5</td>
</tr>
<tr class="odd">
<td>Presence ratio &gt; 0.95</td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="sorting" class="level2">
<h2 class="anchored" data-anchor-id="sorting">Sorting</h2>
<section id="preparing-and-loading-data" class="level3">
<h3 class="anchored" data-anchor-id="preparing-and-loading-data">Preparing and Loading Data</h3>
<p>Run script to convert voltage data into hdf5 file format.</p>
<p>Copy appropriate electrode.cfg file into folder with voltage.</p>
<p>Load HDF5 file into SpikeSorter using sampling rate of 30000 and voltage/bit of 0.195uV</p>
</section>
<section id="pre-processing" class="level3">
<h3 class="anchored" data-anchor-id="pre-processing">Pre-processing</h3>
<p>Subtract mean voltage from all channels</p>
<p>Filter with cutoff of 0.5 Khz high pass</p>
<p>Mask noisy channels</p>
</section>
<section id="event-detection" class="level3">
<h3 class="anchored" data-anchor-id="event-detection">Event Detection</h3>
<p>Event detection and channel masking</p>
</section>
<section id="clustering" class="level3">
<h3 class="anchored" data-anchor-id="clustering">Clustering</h3>
<p>Autosort</p>
<p>Guided Merge Split</p>
<p>View, Clean and Split Clusters</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Consider Splitting Cluster If …</strong></p>
<ul>
<li></li>
</ul>
</div>
</div>
<p>Compare cluster pairs</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Consider Merging Clusters If …</strong></p>
<ul>
<li><p>Asymmetric cross correlation at short time intervals, particularly if second unit has smaller peak-to-peak voltage</p></li>
<li><p>Similar units where merged ACF preserves refractory period</p></li>
<li><p>Similar units where the second appears as the first disappears</p></li>
<li><p>Both units have similar <strong>short term firing patterns</strong>, based on ACF</p></li>
<li><p>Both units have similar <strong>long-term firing patterns</strong>, based on PCs vs experiment time</p></li>
</ul>
</div>
</div>
</section>
</section>
<section id="quality-metrics-revisited" class="level2">
<h2 class="anchored" data-anchor-id="quality-metrics-revisited">Quality Metrics Revisited</h2>
<p>a</p>
</section>
<section id="references" class="level2">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-buccino2020" class="csl-entry" role="listitem">
Buccino, Alessio Paolo, Cole Lincoln Hurwitz, Samuel Garcia, Jeremy Magland, Joshua H Siegle, Roger Hurwitz, and Matthias H Hennig. 2020. <span>“SpikeInterface, a Unified Framework for Spike Sorting.”</span> Edited by Laura L Colgin. <em>eLife</em> 9 (November): e61834. <a href="https://doi.org/10.7554/eLife.61834">https://doi.org/10.7554/eLife.61834</a>.
</div>
<div id="ref-Guo2014" class="csl-entry" role="listitem">
Guo, Zengcai V, Nuo Li, Daniel Huber, Eran Ophir, Diego Gutnisky, Jonathan T Ting, Guoping Feng, and Karel Svoboda. 2014. <span>“Flow of Cortical Activity Underlying a Tactile Decision in Mice.”</span> <em>Neuron</em> 81 (1): 179194. <a href="https://doi.org/10.1016/j.neuron.2013.10.020">https://doi.org/10.1016/j.neuron.2013.10.020</a>.
</div>
<div id="ref-inagaki2022" class="csl-entry" role="listitem">
Inagaki, Hidehiko K., Susu Chen, Margreet C. Ridder, Pankaj Sah, Nuo Li, Zidan Yang, Hana Hasanbegovic, Zhenyu Gao, Charles R. Gerfen, and Karel Svoboda. 2022. <span>“A Midbrain-Thalamus-Cortex Circuit Reorganizes Cortical Dynamics to Initiate Movement.”</span> <em>Cell</em> 185 (6): 1065–1081.e23. <a href="https://doi.org/10.1016/j.cell.2022.02.006">https://doi.org/10.1016/j.cell.2022.02.006</a>.
</div>
<div id="ref-swindale2017" class="csl-entry" role="listitem">
Swindale, Nicholas V., Catalin Mitelut, Timothy H. Murphy, and Martin A. Spacek. 2017. <span>“A Visual Guide to Sorting Electrophysiological Recordings Using ’SpikeSorter’.”</span> <em>Journal of Visualized Experiments: JoVE</em>, no. 120 (February): 55217. <a href="https://doi.org/10.3791/55217">https://doi.org/10.3791/55217</a>.
</div>
<div id="ref-swindale2023" class="csl-entry" role="listitem">
Swindale, Nicholas V, Martin A Spacek, Matthew Krause, and Catalin Mitelut. 2023. <span>“Spontaneous Activity in Cortical Neurons Is Stereotyped and Non-Poisson.”</span> <em>Cerebral Cortex</em> 33 (11): 6508–25. <a href="https://doi.org/10.1093/cercor/bhac521">https://doi.org/10.1093/cercor/bhac521</a>.
</div>
<div id="ref-theaxon2012" class="csl-entry" role="listitem">
<em>The Axon guide, electrophysiology and biophysics laboratory techniques</em>. 2012. Sunnyvale, California: Molecular Devices. <a href="http://mdc.custhelp.com/euf/assets/content/Axon%20Guide%203rd%20edition.pdf">http://mdc.custhelp.com/euf/assets/content/Axon%20Guide%203rd%20edition.pdf</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>